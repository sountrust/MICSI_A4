<article id="cm3-global" style="font-family:Segoe UI,Arial,sans-serif; line-height:1.6;">

  <!-- === HEADER === -->
  <div style="background:#002b5c; color:white; padding:20px; border-radius:10px; margin-bottom:25px;">
    <h1 style="margin:0; font-size:1.8em;">CM3 ‚Äî Gestion de la durabilit√© et de l‚Äô√©tat dans Kubernetes</h1>
    <p style="margin:5px 0 0; font-size:1.1em;">Cours magistral ‚Äî 1h</p>
    <p style="font-size:0.95em; margin-top:10px; color:#cce0ff;">
      Objectif : comprendre comment Kubernetes assure la <strong>stabilit√©</strong>, la <strong>persistance</strong> et la <strong>r√©silience</strong> des applications.
    </p>
  </div>

  <!-- === TABLE DES MATI√àRES === -->
  <div style="background:#f3f9ff; border:1px solid #cce0ff; border-radius:8px; padding:15px 20px; margin-bottom:30px;">
    <h2 style="color:#003366; margin-top:0;">üß≠ Sommaire du CM3</h2>
    <ul style="list-style:none; padding-left:10px; font-size:1em;">
      <li><a href="#cm3-bloc1" style="color:#0066cc; text-decoration:none;">üîπ Bloc 1 ‚Äî Du d√©ploiement √©ph√©m√®re √† la supervision du cluster</a></li>
      <li><a href="#cm3-bloc2" style="color:#0066cc; text-decoration:none;">üîπ Bloc 2 ‚Äî Surveillance et gestion des ressources</a></li>
      <li><a href="#cm3-bloc3" style="color:#0066cc; text-decoration:none;">üîπ Bloc 3 ‚Äî Persistance des donn√©es et StatefulSets</a></li>
    </ul>
  </div>

  <!-- === BLOC 1 === -->
  <section id="cm3-bloc1">
    <iframe srcdoc="
      <section id="cm3-bloc1" style="font-family:Segoe UI,Arial,sans-serif; line-height:1.6;">

        <div style="background:#003366; color:#fff; padding:15px 20px; border-radius:8px; margin-bottom:15px;">
          <h2 style="margin:0; font-size:1.6em;">CM3 ‚Äì Gestion de la durabilit√© et de l‚Äô√©tat dans Kubernetes</h2>
          <p style="margin:5px 0 0 0; font-size:1em;">Bloc 1 ‚Äî Du d√©ploiement √©ph√©m√®re √† la supervision du cluster</p>
        </div>
      
        <h3 style="color:#006699;">1. Contexte g√©n√©ral : du d√©ploiement √©ph√©m√®re √† la production</h3>
      
        <p>Dans Kubernetes, <strong>les conteneurs sont par d√©finition √©ph√©m√®res</strong> :
        ils peuvent √™tre d√©truits et recr√©√©s √† tout moment selon les besoins du cluster.
        Cette caract√©ristique garantit la r√©silience, mais impose de comprendre
        <strong>comment l‚Äô√©tat et la durabilit√© sont g√©r√©s</strong>.</p>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px 15px; margin:10px 0;">
          <strong>üéØ Objectif du CM3 :</strong> comprendre comment Kubernetes maintient la stabilit√©,
          la sant√© et la persistance des applications, malgr√© la nature √©ph√©m√®re des conteneurs.
        </div>
      
        <p>Ce cours aborde :</p>
        <ul style="background:#fafafa; border:1px solid #ddd; border-radius:6px; padding:10px 20px;">
          <li>la <strong>r√©action du cluster aux crashs</strong> ;</li>
          <li>la <strong>surveillance des applications</strong> (readiness, liveness) ;</li>
          <li>la <strong>gestion des ressources et de la persistance</strong> ;</li>
          <li>et la <strong>supervision du cluster lui-m√™me</strong>.</li>
        </ul>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h3 style="color:#006699;">2. Gestion des crashs et de l‚Äô√©tat des pods</h3>
      
        <h4 style="color:#0099cc;">2.1 Cycle de vie d‚Äôun Pod</h4>
        <p>Un <strong>Pod</strong> encapsule un ou plusieurs conteneurs partageant le m√™me r√©seau et stockage.  
        Il traverse plusieurs √©tats :</p>
      
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px; border:1px solid #ccc;">√âtat</th><th style="padding:8px; border:1px solid #ccc;">Description</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ddd;">Pending</td><td style="padding:8px; border:1px solid #ddd;">Le pod a √©t√© accept√© mais ses conteneurs ne sont pas encore d√©marr√©s.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Running</td><td style="padding:8px; border:1px solid #ddd;">Tous les conteneurs sont lanc√©s et fonctionnent.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Succeeded</td><td style="padding:8px; border:1px solid #ddd;">Tous les conteneurs se sont termin√©s sans erreur.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Failed</td><td style="padding:8px; border:1px solid #ddd;">Au moins un conteneur s‚Äôest arr√™t√© avec une erreur.</td></tr>
            <tr style="background:#fff6e6;"><td style="padding:8px; border:1px solid #ddd;"><strong>CrashLoopBackOff</strong></td><td style="padding:8px; border:1px solid #ddd;">Le conteneur √©choue et red√©marre en boucle.</td></tr>
          </tbody>
        </table>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl get pods -w
      kubectl describe pod &lt;nom&gt;
      kubectl logs &lt;nom&gt;
        </pre>
      
        <h4 style="color:#0099cc;">2.2 Comportement en cas de crash</h4>
        <ol>
          <li>Le <strong>kubelet</strong> d√©tecte l‚Äô√©chec du conteneur.</li>
          <li>Il consulte la politique de red√©marrage :</li>
        </ol>
      
        <pre style="background:#f6f8fa; padding:10px; border-radius:5px; border-left:4px solid #007acc;">restartPolicy: Always</pre>
      
        <p>Le conteneur est relanc√© automatiquement, assurant une <strong>auto-gu√©rison</strong> basique.</p>
      
        <h4 style="color:#0099cc;">2.3 R√¥le du runtime (Containerd)</h4>
        <p>Le kubelet s‚Äôappuie sur <strong>Containerd</strong> ou <strong>CRI-O</strong> pour g√©rer la cr√©ation, l‚Äôex√©cution et la supervision des conteneurs.</p>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      minikube ssh
      sudo ctr containers list
        </pre>
      
        <p style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          üí° Le conteneur peut subsister temporairement m√™me apr√®s la suppression du pod Kubernetes.
        </p>
      
        <h4 style="color:#0099cc;">2.4 CrashLoopBackOff</h4>
        <p>Kubernetes tente p√©riodiquement de red√©marrer le conteneur √©chou√© avec une d√©sactivation exponentielle :</p>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      Warning  BackOff  kubelet  Back-off restarting failed container
        </pre>
      
        <h4 style="color:#0099cc;">2.5 Nettoyage et persistance</h4>
        <ul>
          <li>Les fichiers internes au conteneur sont <strong>perdus</strong> √† la suppression.</li>
          <li>Les donn√©es mont√©es sur un <strong>volume persistant</strong> (PV) sont conserv√©es.</li>
        </ul>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px; margin:10px 0;">
          üí° Nous verrons dans la suite comment rendre ces donn√©es persistantes.
        </div>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h3 style="color:#006699;">2 bis. Sant√© du cluster et supervision des pods syst√®mes</h3>
      
        <h4 style="color:#0099cc;">Namespace kube-system</h4>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">kubectl get pods -n kube-system</pre>
      
        <h4 style="color:#0099cc;">Services vitaux du cluster</h4>
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead style="background:#003366; color:white;">
            <tr><th style="padding:8px;">Composant</th><th style="padding:8px;">R√¥le principal</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ccc;">CoreDNS</td><td style="padding:8px;">R√©solution interne de noms entre pods et services.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">etcd</td><td style="padding:8px;">Base de donn√©es cl√©-valeur stockant l‚Äô√©tat du cluster.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">kube-apiserver</td><td style="padding:8px;">API du plan de contr√¥le : coh√©rence et validation des objets Kubernetes.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">kube-scheduler</td><td style="padding:8px;">Affectation des pods aux n≈ìuds disponibles.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">controller-manager</td><td style="padding:8px;">Application des boucles de r√©conciliation.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">kube-proxy</td><td style="padding:8px;">Routage du trafic entre services et pods.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">kindnet / calico / flannel</td><td style="padding:8px;">Gestion du r√©seau inter-pods.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">minikube addons manager</td><td style="padding:8px;">Gestion des extensions locales.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">kubelet</td><td style="padding:8px;">Agent ex√©cutant les conteneurs sur chaque n≈ìud.</td></tr>
          </tbody>
        </table>
      
        <h4 style="color:#0099cc;">2.8 Configuration du plan de contr√¥le</h4>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      minikube ssh
      ls /etc/kubernetes/manifests
      cat kube-apiserver.yaml
        </pre>
      
        <div style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          ‚öôÔ∏è <strong>Le kubelet</strong> g√®re ces pods statiques localement, ind√©pendamment de l‚ÄôAPI server.
        </div>
      
        <h4 style="color:#0099cc;">2.9 Monitoring avec un DaemonSet (Glances)</h4>
        <pre style="background:#f6f8fa; border-left:4px solid #007acc; padding:10px;">
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: glances
      spec:
        selector:
          matchLabels:
            app: glances
        template:
          metadata:
            labels:
              app: glances
          spec:
            containers:
              - name: glances
                image: nicolargo/glances:latest
                ports:
                  - containerPort: 61208
                volumeMounts:
                  - mountPath: /var/run/docker.sock
                    name: docker-sock
            volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock
        </pre>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl get daemonsets
      kubectl get pods -l app=glances -o wide
        </pre>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <div style="background:#f3f9ff; border-left:5px solid #007acc; padding:10px 15px;">
          <h4 style="margin-top:0;">üîç Synth√®se du Bloc 1</h4>
          <ul>
            <li>Les pods sont √©ph√©m√®res mais Kubernetes assure leur <strong>auto-r√©cup√©ration</strong>.</li>
            <li>Le <strong>kubelet</strong> et <strong>Containerd</strong> pilotent le cycle de vie des conteneurs.</li>
            <li>Le namespace <code>kube-system</code> regroupe les <strong>services vitaux</strong> du cluster.</li>
            <li>Les manifests statiques maintiennent le plan de contr√¥le.</li>
            <li>Les <strong>DaemonSets</strong> d√©ploient des agents de monitoring sur chaque n≈ìud.</li>
          </ul>
        </div>
      
      </section>" style="width:100%; height:2000px; border:none;"></iframe>
  </section>

  <!-- === BLOC 2 === -->
  <section id="cm3-bloc2" style="margin-top:40px;">
    <iframe srcdoc="
      <section id="cm3-bloc2" style="font-family:Segoe UI,Arial,sans-serif; line-height:1.6;">

        <div style="background:#003366; color:#fff; padding:15px 20px; border-radius:8px; margin-bottom:15px;">
          <h2 style="margin:0; font-size:1.6em;">Bloc 2 ‚Äî Surveillance et gestion des ressources</h2>
          <p style="margin:5px 0 0 0; font-size:1em;">CM3 ‚Äì Gestion de la durabilit√© et de l‚Äô√©tat dans Kubernetes</p>
        </div>
      
        <h3 style="color:#006699;">3. Surveillance de l‚Äôapplication : readiness et liveness probes</h3>
      
        <h4 style="color:#0099cc;">3.1 Pourquoi surveiller ?</h4>
        <p>
          Un pod peut √™tre <strong>en cours d‚Äôex√©cution</strong> sans √™tre <strong>fonctionnel</strong>.
          Les probes (ou sondes) permettent √† Kubernetes de <strong>v√©rifier la sant√© et la disponibilit√©</strong> d‚Äôun conteneur.
        </p>
      
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px; border:1px solid #ccc;">Type de sonde</th>
                <th style="padding:8px; border:1px solid #ccc;">Objectif principal</th>
                <th style="padding:8px; border:1px solid #ccc;">Comportement</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ddd;"><strong>Liveness Probe</strong></td><td>V√©rifie si le conteneur est encore vivant.</td><td>Red√©marre le conteneur si la v√©rification √©choue.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;"><strong>Readiness Probe</strong></td><td>V√©rifie si le conteneur est pr√™t √† recevoir du trafic.</td><td>Retire le pod du Service jusqu‚Äô√† r√©tablissement.</td></tr>
            <tr style="background:#fff6e6;"><td style="padding:8px; border:1px solid #ddd;"><strong>Startup Probe</strong></td><td>V√©rifie si le conteneur a fini de d√©marrer.</td><td>Accorde un d√©lai avant d‚Äôactiver les autres sondes.</td></tr>
          </tbody>
        </table>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px; margin:15px 0;">
          üí° Les probes assurent la <strong>r√©silience</strong> : Kubernetes red√©marre automatiquement un pod non sain.
        </div>
      
        <h4 style="color:#0099cc;">√Ä propos des endpoints <code>/healthz</code> et <code>/ready</code></h4>
        <p>Les applications exposent souvent des points de supervision standards :</p>
      
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead style="background:#003366; color:white;">
            <tr><th style="padding:8px;">Endpoint</th><th style="padding:8px;">Usage</th><th style="padding:8px;">Description</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ccc;"><code>/healthz</code></td><td>Liveness</td><td>V√©rifie que l‚Äôapplication r√©pond encore.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;"><code>/ready</code> ou <code>/readiness</code></td><td>Readiness</td><td>V√©rifie que l‚Äôapplication est pr√™te √† recevoir des requ√™tes.</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;"><code>/metrics</code></td><td>Monitoring</td><td>Expose des m√©triques (Prometheus, Grafana...).</td></tr>
          </tbody>
        </table>
      
        <blockquote style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          Ces endpoints sont <strong>standardis√©s par convention</strong> : Kubernetes ne les impose pas,
          mais la plupart des frameworks modernes les impl√©mentent.
        </blockquote>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h4 style="color:#0099cc;">3.2 M√©thodes techniques de probes</h4>
        <p>Chaque sonde peut utiliser diff√©rentes m√©thodes pour effectuer son test :</p>
      
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px;">M√©thode</th><th style="padding:8px;">Description</th><th style="padding:8px;">Exemple</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ddd;">HTTP GET</td><td>Teste la r√©ponse d‚Äôun endpoint HTTP.</td><td><code>/healthz</code></td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">TCP Socket</td><td>Teste la connectivit√© sur un port.</td><td><code>8080</code></td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Exec Command</td><td>Ex√©cute une commande locale et v√©rifie le code retour.</td><td><code>ps aux</code></td></tr>
          </tbody>
        </table>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 5
      
      readinessProbe:
        tcpSocket:
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 5
        </pre>
      
        <h4 style="color:#0099cc;">3.3 Bonnes pratiques</h4>
        <ul style="background:#fafafa; border:1px solid #ddd; border-radius:6px; padding:10px 20px;">
          <li>Utiliser un <strong>d√©lai initial</strong> (<code>initialDelaySeconds</code>) pour laisser l‚Äôapplication d√©marrer.</li>
          <li>Ajuster la fr√©quence (<code>periodSeconds</code>) aux temps de r√©ponse r√©els.</li>
          <li>D√©finir des seuils : <code>failureThreshold</code> / <code>successThreshold</code>.</li>
          <li>Aligner les endpoints de test avec la logique applicative.</li>
        </ul>
        <p style="color:#cc0000;">‚ö†Ô∏è Des probes trop fr√©quentes peuvent provoquer des red√©marrages inutiles.</p>
      
        <h4 style="color:#0099cc;">3.4 Exemple : application Flask</h4>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      from flask import Flask
      app = Flask(__name__)
      
      @app.route('/healthz')
      def health():
          return 'OK', 200
        </pre>
      
        <pre style="background:#f6f8fa; padding:10px; border-left:4px solid #007acc;">
      containers:
        - name: web
          image: myapp:latest
          ports:
            - containerPort: 5000
          livenessProbe:
            httpGet:
              path: /healthz
              port: 5000
            initialDelaySeconds: 5
            periodSeconds: 5
        </pre>
      
        <p>‚û°Ô∏è Si Flask cesse de r√©pondre, Kubernetes red√©marre automatiquement le conteneur.</p>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h3 style="color:#006699;">4. Gestion des ressources : CPU et m√©moire</h3>
      
        <h4 style="color:#0099cc;">4.1 Pourquoi limiter les ressources ?</h4>
        <p>
          Kubernetes mutualise les ressources d‚Äôun n≈ìud entre plusieurs pods.
          D√©finir des <strong>requests</strong> et <strong>limits</strong> garantit
          une utilisation √©quilibr√©e et pr√©vient la saturation.
        </p>
      
        <pre style="background:#f6f8fa; border-left:4px solid #007acc; padding:10px;">
      resources:
        requests:
          cpu: "500m"
          memory: "256Mi"
        limits:
          cpu: "1"
          memory: "512Mi"
        </pre>
      
        <ul>
          <li><code>requests</code> : quantit√© minimale garantie pour le conteneur.</li>
          <li><code>limits</code> : plafond maximal autoris√©.</li>
        </ul>
      
        <div style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          üßÆ <strong>1 CPU = 1000 m</strong> (millicores). Une limite de 500 m correspond √† 50 % d‚Äôun c≈ìur.
        </div>
      
        <h4 style="color:#0099cc;">4.3 Effets des d√©passements</h4>
        <ul>
          <li><strong>D√©passement m√©moire</strong> : conteneur tu√© (<code>OOMKilled</code>).</li>
          <li><strong>D√©passement CPU</strong> : conteneur ralenti (throttling).</li>
        </ul>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl describe pod &lt;nom&gt;
      # Chercher les √©v√©nements 'OOMKilled' ou 'Throttling CPU'
        </pre>
      
        <h4 style="color:#0099cc;">4.4 R√©servation et surallocation</h4>
        <p>
          Kubernetes autorise la <strong>surallocation contr√¥l√©e</strong> :
          plusieurs pods peuvent demander plus que la capacit√© totale du n≈ìud.
          Le <strong>scheduler</strong> arbitre dynamiquement selon la charge r√©elle.
        </p>
      
        <h4 style="color:#0099cc;">4.5 Priorit√©s des pods</h4>
        <pre style="background:#f6f8fa; border-left:4px solid #007acc; padding:10px;">
      apiVersion: scheduling.k8s.io/v1
      kind: PriorityClass
      metadata:
        name: high-priority
      value: 1000
      preemptionPolicy: PreemptLowerPriority
        </pre>
      
        <pre style="background:#f6f8fa; padding:10px;">
      spec:
        priorityClassName: high-priority
        </pre>
      
        <p>Un pod √† haute priorit√© peut pr√©empter un autre lorsque les ressources manquent.</p>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <div style="background:#f3f9ff; border-left:5px solid #007acc; padding:10px 15px;">
          <h4 style="margin-top:0;">üîç Synth√®se du Bloc 2</h4>
          <ul>
            <li>Les <strong>probes</strong> assurent la sant√© et la disponibilit√© des pods.</li>
            <li>Les sondes <strong>liveness</strong>, <strong>readiness</strong> et <strong>startup</strong> contr√¥lent vitalit√© et d√©marrage.</li>
            <li>Les <strong>requests</strong> et <strong>limits</strong> encadrent la consommation de ressources.</li>
            <li>Les <strong>PriorityClasses</strong> maintiennent la continuit√© des services essentiels.</li>
          </ul>
          <p>Ces notions permettent √† Kubernetes d‚Äôassurer la <strong>qualit√© de service (QoS)</strong> et la <strong>r√©silience applicative</strong> du cluster.</p>
        </div>
      
      </section>" style="width:100%; height:2000px; border:none;"></iframe>
  </section>

  <!-- === BLOC 3 === -->
  <section id="cm3-bloc3" style="margin-top:40px;">
    <iframe srcdoc="
      <section id="cm3-bloc3" style="font-family:Segoe UI,Arial,sans-serif; line-height:1.6;">

        <div style="background:#003366; color:#fff; padding:15px 20px; border-radius:8px; margin-bottom:15px;">
          <h2 style="margin:0; font-size:1.6em;">Bloc 3 ‚Äî Persistance des donn√©es et StatefulSets</h2>
          <p style="margin:5px 0 0 0; font-size:1em;">CM3 ‚Äì Gestion de la durabilit√© et de l‚Äô√©tat dans Kubernetes</p>
        </div>
      
        <h3 style="color:#006699;">5. Persistance des donn√©es</h3>
      
        <h4 style="color:#0099cc;">5.1 Pourquoi la persistance est-elle n√©cessaire ?</h4>
        <p>
          Les pods Kubernetes sont <strong>√©ph√©m√®res</strong> : lors d‚Äôun red√©marrage, leur syst√®me de fichiers est reconstruit √† partir de l‚Äôimage du conteneur.  
          Toute donn√©e stock√©e localement est donc <strong>perdue</strong>.
        </p>
        <p>
          Pour les applications manipulant des donn√©es (bases, messagerie, journaux, etc.), il faut un moyen de <strong>pr√©server ces informations entre les cycles de vie</strong>.
          Kubernetes fournit pour cela les objets <strong>PersistentVolume (PV)</strong> et <strong>PersistentVolumeClaim (PVC)</strong>, qui dissocient la dur√©e de vie du stockage de celle du pod.
        </p>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h4 style="color:#0099cc;">5.2 Cr√©ation manuelle : PV + PVC li√©s statiquement</h4>
      
        <h5 style="color:#007acc;">a. √âtape 1 ‚Äî D√©finir un PersistentVolume (PV)</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: pv-demo
      spec:
        capacity:
          storage: 1Gi
        accessModes:
          - ReadWriteOnce
        hostPath:
          path: /data/demo
        </pre>
      
        <p>Ce volume est stock√© localement sur le n≈ìud dans <code>/data/demo</code>.</p>
      
        <h5 style="color:#007acc;">b. √âtape 2 ‚Äî Cr√©er un PersistentVolumeClaim (PVC)</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: pvc-demo
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        </pre>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl get pv,pvc
        </pre>
      
        <h5 style="color:#007acc;">c. √âtape 3 ‚Äî Utiliser le PVC dans un Pod</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: v1
      kind: Pod
      metadata:
        name: demo-pod
      spec:
        containers:
          - name: demo
            image: busybox
            command: ["sleep", "3600"]
            volumeMounts:
              - mountPath: /mnt/data
                name: demo-volume
        volumes:
          - name: demo-volume
            persistentVolumeClaim:
              claimName: pvc-demo
        </pre>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px; margin:10px 0;">
          üí° Le pod acc√®de au r√©pertoire <code>/data/demo</code> sous <code>/mnt/data</code> dans le conteneur.
        </div>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h4 style="color:#0099cc;">5.3 Du mod√®le statique au mod√®le dynamique (StorageClass)</h4>
        <p>
          Cr√©er chaque PV √† la main est lourd √† maintenir.  
          Kubernetes introduit les <strong>StorageClasses</strong> pour un <strong>provisionnement dynamique</strong>.
        </p>
      
        <h5 style="color:#007acc;">a. StorageClass : principe</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: standard
      provisioner: k8s.io/minikube-hostpath
      reclaimPolicy: Delete
      volumeBindingMode: Immediate
        </pre>
      
        <h5 style="color:#007acc;">b. PVC dynamique</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: pvc-dyn
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
        storageClassName: standard
        </pre>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px;">
          üí° Aucun PV n‚Äôest cr√©√© √† la main : Kubernetes le provisionne automatiquement via la StorageClass.
        </div>
      
        <h5 style="color:#cc0000;">‚ö†Ô∏è Limite du provisionnement dynamique</h5>
        <blockquote style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          Le provisionnement dynamique ne garantit pas la <strong>portabilit√© du stockage</strong> entre n≈ìuds :<br/>
          ‚Äî avec un <strong>stockage r√©seau</strong> (NFS, CephFS, CSI Cloud‚Ä¶), les volumes sont accessibles de partout ;<br/>
          ‚Äî avec un <strong>disque local</strong>, le volume reste attach√© √† un seul n≈ìud (g√©r√© par <code>nodeAffinity</code> ou <code>WaitForFirstConsumer</code>).  
          üëâ Ce mod√®le est pertinent uniquement avec un backend r√©seau partag√©.
        </blockquote>
      
        <h5 style="color:#007acc;">c. Comparatif</h5>
        <table style="width:100%; border-collapse:collapse; margin:10px 0;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px;">Aspect</th><th style="padding:8px;">PV/PVC statiques</th><th style="padding:8px;">StorageClass dynamique</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ddd;">Cr√©ation du volume</td><td>Manuelle</td><td>Automatique</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Association PV‚ÄìPVC</td><td>Bas√©e sur correspondance</td><td>G√©r√©e par le provisioner</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Portabilit√©</td><td>Limit√©e</td><td>Optimale (stockage r√©seau)</td></tr>
            <tr><td style="padding:8px; border:1px solid #ddd;">Cas d‚Äôusage</td><td>D√©monstration, local</td><td>Cluster multi-n≈ìuds, cloud</td></tr>
          </tbody>
        </table>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h4 style="color:#0099cc;">5.4 Modes d‚Äôacc√®s, s√©curit√© et typologie</h4>
      
        <h5 style="color:#007acc;">a. Modes d‚Äôacc√®s</h5>
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#003366; color:#fff;">
            <tr><th style="padding:8px;">Mode</th><th style="padding:8px;">Signification</th><th style="padding:8px;">Usage</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ccc;">ReadWriteOnce (RWO)</td><td>Lecture/√©criture par un seul n≈ìud</td><td>Bases de donn√©es</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">ReadOnlyMany (ROX)</td><td>Lecture seule par plusieurs n≈ìuds</td><td>Contenu statique</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">ReadWriteMany (RWX)</td><td>Lecture/√©criture simultan√©e</td><td>NFS, CephFS</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">ReadWriteOncePod (RWOP)</td><td>Acc√®s exclusif par un pod</td><td>Cas sensibles</td></tr>
          </tbody>
        </table>
      
        <h5 style="color:#007acc;">b. S√©curit√© et permissions</h5>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      securityContext:
        runAsUser: 1000
        fsGroup: 1000
        </pre>
      
        <h5 style="color:#007acc;">c. Types de backend</h5>
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px;">Type</th><th style="padding:8px;">Description</th><th style="padding:8px;">Particularit√©s</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ccc;">hostPath / local</td><td>Stockage local du n≈ìud</td><td>Rapide mais non partag√©</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">NFS</td><td>Partage r√©seau simple</td><td>Compatible RWX</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">CSI Driver</td><td>Interface standard</td><td>Supporte Ceph, EBS, Azure...</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">CephFS / RBD</td><td>Stockage distribu√©</td><td>Haute disponibilit√©</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">Cloud storage</td><td>EBS, Persistent Disk, etc.</td><td>Provisionnement dynamique</td></tr>
          </tbody>
        </table>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <h3 style="color:#006699;">6. StatefulSets et bases de donn√©es</h3>
      
        <h4 style="color:#0099cc;">6.1 Limites des Deployments</h4>
        <p>
          Les <strong>Deployments</strong> conviennent aux applications <em>stateless</em>.  
          Pour les bases de donn√©es ou services √† √©tat, on utilise les <strong>StatefulSets</strong>.
        </p>
      
        <blockquote style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          ‚ö†Ô∏è Kubernetes ne g√®re pas la coh√©rence interne des donn√©es (r√©plication, transactions).  
          Cela reste du ressort du moteur SGBD (MySQL, PostgreSQL, MongoDB...).
        </blockquote>
      
        <h4 style="color:#0099cc;">6.2 Caract√©ristiques d‚Äôun StatefulSet</h4>
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#e6f2ff; color:#003366;">
            <tr><th style="padding:8px;">Fonction</th><th style="padding:8px;">Description</th></tr>
          </thead>
          <tbody>
            <tr><td style="padding:8px; border:1px solid #ccc;">Identit√© stable</td><td>Pods nomm√©s s√©quentiellement (<code>app-0</code>, <code>app-1</code>...)</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">Volume d√©di√©</td><td>Chaque pod poss√®de son propre PVC</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">Ordre contr√¥l√©</td><td>Cr√©ation et suppression ordonn√©es</td></tr>
            <tr><td style="padding:8px; border:1px solid #ccc;">Stabilit√©</td><td>Conservation du nom et du volume</td></tr>
          </tbody>
        </table>
      
        <h4 style="color:#0099cc;">6.3 Exemple : MariaDB avec StatefulSet</h4>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: mariadb
      spec:
        serviceName: mariadb
        replicas: 1
        selector:
          matchLabels:
            app: mariadb
        template:
          metadata:
            labels:
              app: mariadb
          spec:
            containers:
              - name: mariadb
                image: mariadb:10.11
                env:
                  - name: MYSQL_ROOT_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: mariadb-secret
                        key: root-password
                ports:
                  - containerPort: 3306
                volumeMounts:
                  - name: data
                    mountPath: /var/lib/mysql
        volumeClaimTemplates:
          - metadata:
              name: data
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 2Gi
        </pre>
      
        <div style="background:#f3f9ff; border-left:4px solid #007acc; padding:10px;">
          üîπ <code>volumeClaimTemplates</code> cr√©e un PVC par pod (<code>data-mariadb-0</code>, etc.).  
          üîπ Si <code>replicas&gt;1</code>, chaque instance est ind√©pendante sans r√©plication configur√©e.  
          üîπ Pour la coh√©rence : utiliser Galera, Group Replication et un Service Headless.
        </div>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl get statefulsets
      kubectl get pods -l app=mariadb
      kubectl get pvc | grep mariadb
        </pre>
      
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      kubectl scale statefulset mariadb --replicas=3
        </pre>
      
        <blockquote style="background:#fff8e1; border-left:4px solid #ff9800; padding:10px;">
          Kubernetes orchestre les pods et volumes, mais pas la logique transactionnelle.
        </blockquote>
      
        <h4 style="color:#0099cc;">6.5 ConfigMaps et Secrets</h4>
        <pre style="background:#1e1e1e; color:#dcdcdc; padding:10px; border-radius:6px;">
      apiVersion: v1
      kind: Secret
      metadata:
        name: mariadb-secret
      type: Opaque
      data:
        root-password: bXlzZWNyZXRwYXNzCg==
        </pre>
      
        <p>
          Les <strong>Secrets</strong> et <strong>ConfigMaps</strong> stockent configuration et mots de passe de mani√®re s√©curis√©e.  
          Ils sont <em>namespaced</em> et li√©s au cycle de vie du d√©ploiement.
        </p>
      
        <hr style="border:0; border-top:2px solid #007acc; margin:25px 0;"/>
      
        <div style="background:#f3f9ff; border-left:5px solid #007acc; padding:10px 15px;">
          <h4 style="margin-top:0;">üß† Synth√®se du Bloc 3</h4>
          <ul>
            <li>Les <strong>PV/PVC</strong> assurent la persistance des donn√©es.</li>
            <li>Les <strong>StorageClasses</strong> permettent le provisionnement dynamique.</li>
            <li>Ce mod√®le est efficace avec un <strong>stockage r√©seau</strong> partag√©.</li>
            <li>Les modes d‚Äôacc√®s, droits et backends d√©terminent la souplesse du stockage.</li>
            <li>Les <strong>StatefulSets</strong> g√®rent les applications avec √©tat, la coh√©rence restant applicative.</li>
          </ul>
          <p>üí° Kubernetes orchestre la <strong>durabilit√©</strong>, la <strong>stabilit√©</strong> et la <strong>persistance</strong> des applications distribu√©es.</p>
        </div>
      
      </section>" style="width:100%; height:2400px; border:none;"></iframe>
  </section>

  <!-- === PIED DE PAGE === -->
  <footer style="background:#002b5c; color:white; margin-top:50px; padding:15px 20px; border-radius:10px;">
    <p style="margin:0; font-size:0.95em;">
      ¬© Virtualisation Avanc√©e ‚Äì Cours CM3 | Kubernetes et persistance des applications
    </p>
  </footer>

</article>
